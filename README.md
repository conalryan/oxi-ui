# Canon

Canonical Front-End library generated by AI - A modern monorepo using Bun + Vite + OXC.

## Overview

Canon is a frontend monorepo that provides:

- **@canon/core** - Core TypeScript library with authentication, feature flags, permissions, and utilities
- **@canon/web-components** - Lit-based web components with React and Angular wrappers

## Quick Start

```bash
# Install dependencies
bun install

# Build all packages
bun run build

# Run tests
bun run test

# Run tests with coverage
bun run test:coverage

# Lint code
bun run lint

# Format code
bun run format
```

## Packages

### @canon/core

Core utilities library with tree-shakable exports:

```typescript
// Import specific modules
import { isAuthorized } from '@canon/core/authentication';
import { isEnabled } from '@canon/core/feature-flags';
import { hasPermission } from '@canon/core/permissions';
import { debounce, throttle } from '@canon/core/utils';

// Or import everything
import { isAuthorized, isEnabled, hasPermission, debounce } from '@canon/core';
```

#### Authentication

```typescript
import { isAuthorized } from '@canon/core/authentication';

const session = {
  userId: 'user-123',
  roles: ['admin', 'user'],
  expiresAt: '2026-12-31T23:59:59Z',
  permissions: ['read', 'write']
};

const result = isAuthorized(session, {
  requiredRoles: ['admin'],
  requiredPermissions: ['read']
});

if (result.authorized) {
  // User has access
}
```

#### Feature Flags

```typescript
import { initializeFeatureFlags, isEnabled } from '@canon/core/feature-flags';

initializeFeatureFlags([
  { id: 'new-dashboard', name: 'New Dashboard', enabled: true },
  { id: 'beta-feature', name: 'Beta', enabled: true, rolloutPercentage: 50 }
]);

if (isEnabled('new-dashboard')) {
  // Show new dashboard
}

if (isEnabled('beta-feature', { userId: 'user-123' })) {
  // Show beta feature (50% rollout)
}
```

### @canon/web-components

Lit-based web components with framework wrappers:

#### Web Components (Vanilla JS/HTML)

```html
<script type="module">
  import '@canon/web-components';
</script>

<canon-button variant="primary" size="medium">Click me</canon-button>

<canon-text-field
  label="Email"
  type="email"
  placeholder="Enter your email"
  required
></canon-text-field>
```

#### React

```tsx
import { CanonButton, CanonTextField } from '@canon/web-components/react';

function App() {
  const [email, setEmail] = useState('');

  return (
    <>
      <CanonButton variant="primary" onClick={() => console.log('clicked')}>
        Submit
      </CanonButton>

      <CanonTextField
        label="Email"
        type="email"
        value={email}
        onInput={(e) => setEmail(e.detail.value)}
      />
    </>
  );
}
```

#### Angular

```typescript
import { CanonComponentsModule } from '@canon/web-components/angular';

@NgModule({
  imports: [CanonComponentsModule],
})
export class AppModule {}
```

```html
<canon-button-wrapper variant="primary" (canonClick)="handleClick($event)">
  Submit
</canon-button-wrapper>

<canon-text-field-wrapper
  label="Email"
  type="email"
  [value]="email"
  (canonInput)="onEmailInput($event)"
>
</canon-text-field-wrapper>
```

## Development

### Build a specific package

```bash
bun run build:core
bun run build:web-components
```

### Test a specific package

```bash
bun run test:core
bun run test:web-components
```

### Package Scripts

Each package supports:
- `build` - Build the package with Vite
- `test` - Run tests with Bun
- `test:coverage` - Run tests with coverage
- `clean` - Remove dist and coverage directories
- `typecheck` - Run TypeScript type checking

## Architecture

### Monorepo Structure

```
canon/
├── package.json          # Root workspace config
├── bunfig.toml          # Bun configuration
├── tsconfig.json        # Base TypeScript config
├── packages/
│   ├── core/            # @canon/core
│   │   ├── src/
│   │   │   ├── authentication/
│   │   │   ├── feature-flags/
│   │   │   ├── permissions/
│   │   │   └── utils/
│   │   └── vite.config.ts
│   └── web-components/  # @canon/web-components
│       ├── src/
│       │   ├── button/
│       │   ├── text-field/
│       │   ├── react/
│       │   └── angular/
│       └── vite.config.ts
└── prompts/             # AI generation prompts
```

### Technology Stack

- **Runtime**: [Bun](https://bun.sh) - Fast JavaScript runtime and package manager
- **Bundler**: [Vite](https://vitejs.dev) - Next-generation frontend tooling
- **Linting**: [OXLint](https://oxc-project.github.io/docs/guide/usage/linter.html) - Fast Rust-based linter
- **Web Components**: [Lit](https://lit.dev) - Simple, fast web components
- **Testing**: Bun test runner with built-in coverage

### Key Features

- ✅ Independent package versioning, building, testing, and publishing
- ✅ Caching - only necessary tasks run
- ✅ Parallel task execution with dependency resolution
- ✅ Tree-shakable exports for optimal bundle size
- ✅ Minification and production-ready builds
- ✅ 90%+ code coverage target
- ✅ TypeScript with strict mode
- ✅ Framework-agnostic web components
- ✅ React and Angular wrapper components

## Docker

### Development with Docker

Run the full CI pipeline locally:

```bash
# Run all checks (lint, test, build)
./scripts/ci-local.sh all

# Or run individual steps
./scripts/ci-local.sh lint
./scripts/ci-local.sh test
./scripts/ci-local.sh build
```

### Docker Targets

The Dockerfile supports multiple build targets:

```bash
# Development environment (default)
docker build --target development -t canon-dev .

# Run tests
docker build --target test -t canon-test .

# Run linting
docker build --target lint -t canon-lint .

# Full CI pipeline
docker build --target ci -t canon-ci .

# Production (built packages only)
docker build --target production -t canon-prod .
```

### VS Code Dev Container

Open this repository in VS Code and use the "Reopen in Container" command for a fully configured development environment with:

- Bun runtime and package manager
- All VS Code extensions pre-installed
- Port forwarding for development servers
- Persistent node_modules and Bun cache volumes

## CI/CD with Jenkins

### Pipeline Features

The Jenkinsfile provides:

- **Change Detection** - Only builds/tests/publishes packages with changes
- **Parallel Execution** - Lint, test, and build run in parallel per package
- **Conventional Commits** - Auto-detects version bump from commit messages
- **Independent Semver** - Each package maintains its own version
- **Dry Run Mode** - Test publishing without actually releasing

### Pipeline Stages

1. **Setup** - Install dependencies, detect changed packages
2. **Quality Gates** - Lint and format check (parallel)
3. **Test** - Run tests with coverage (parallel per package)
4. **Build** - Build changed packages (parallel)
5. **Version & Publish** - Bump versions and publish to npm (main branch only)

### Manual Versioning

```bash
# Bump a specific package version
./scripts/bump-version.sh core patch   # 0.1.0 -> 0.1.1
./scripts/bump-version.sh core minor   # 0.1.0 -> 0.2.0
./scripts/bump-version.sh core major   # 0.1.0 -> 1.0.0

./scripts/bump-version.sh web-components patch
```

### Change Detection

```bash
# Detect which packages have changes
./scripts/detect-changes.sh

# Compare against a specific base ref
./scripts/detect-changes.sh HEAD~5
./scripts/detect-changes.sh main
```

### Publish Changed Packages

```bash
# Dry run (see what would be published)
./scripts/publish-changed.sh --dry-run

# Actually publish
./scripts/publish-changed.sh
```

### Jenkins Configuration

Required Jenkins credentials:
- `npm-token` - NPM authentication token for publishing
- `github-ssh-key` - SSH key for pushing tags and version commits

### Conventional Commits

The pipeline uses conventional commits to determine version bumps:

| Commit Type | Version Bump |
|-------------|--------------|
| `feat:` or `feat(scope):` | Minor |
| `fix:` or `fix(scope):` | Patch |
| `BREAKING CHANGE` or `!:` | Major |
| Other | Patch (default) |

## Documentation

- [Workspace Recommendations](./prompts/WORKSPACE_RECOMMENDATIONS.md)
- [Modern Tooling Recommendations](./prompts/MODERN_TOOLING_RECOMMENDATIONS.md)

## License

MIT
